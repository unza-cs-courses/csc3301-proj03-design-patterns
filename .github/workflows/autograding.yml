name: Autograder

on: [push]

jobs:
  grade:
    name: Run Tests and Grade
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest mypy coverage pytest-cov

    - name: Check variant configuration
      run: |
        if [ -f ".variant_config.json" ]; then
          echo "Variant configuration found"
          cat .variant_config.json
        else
          echo "No variant configuration - using defaults"
        fi

    - name: Run visible tests
      run: |
        pytest tests/visible/ -v --tb=short

    - name: Run tests with coverage
      run: |
        pytest tests/visible/ --cov=src --cov-report=term-missing --cov-report=xml
      continue-on-error: true

    - name: Type checking with mypy
      run: |
        mypy src/ --ignore-missing-imports || true

    - name: Generate grade report
      if: always()
      run: |
        echo "=== Grading Report ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f ".variant_config.json" ]; then
          echo "**Student Variant Loaded**" >> $GITHUB_STEP_SUMMARY
          python -c "import json; c=json.load(open('.variant_config.json')); print(f\"Patterns: {', '.join(c.get('all_patterns', []))}\")" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check test output above for detailed results." >> $GITHUB_STEP_SUMMARY
